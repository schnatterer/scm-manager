# Architecture

## Annotations

### Introduction

One of the base technologies which defines the architecture for SCM-Manager is the self written SCM-Annotation-Processor.
There are actually two modules for this which are included in the SCM-Manager main repository:
`scm-annotation-processor` and `scm-annotations`.

### SCM-Annotation-Processor

Firstly we need to clarify why we need this self written annotation processor.
In the build process of the SCM-Manager core and plugins the SCM-Annotations are getting collected.
Some part of the provided information is appended to the `plugin.xml` respectively `module.xml`.

The SCM-Annotation-Processor processes the annotations `Subscribe`, `PluginAnnotation`, `Requires`, `Path` and `Provider`.

This information could look like this in the `plugin.xml`:

- The `extension` that should be bound to an existing `extension-point`:

```xml
    <extension>
        <class>sonia.scm.api.v2.resources.GitRepositoryConfigEnricher</class>
    </extension>
```

- The `event subscriber` which is listening to a specific event:

```xml
    <subscriber>
        <class>sonia.scm.api.v2.resources.GitRepositoryConfigChangeClearRepositoryCacheListener</class>
        <event>sonia.scm.api.v2.resources.GitRepositoryConfigChangedEvent</event>
    </subscriber>
```

- The rest api paths and resources:

```xml
<rest-resource>
      <description>RESTful Web Service Resource to manage the configuration of the git plugin.</description>
      <value>v2/config/git</value>
      <class>sonia.scm.api.v2.resources.GitConfigResource</class>
</rest-resource>
```

All this information is auto generated by the SCM-Annotations-Processor from the SCM-Annotations which we use in the code.
On starting SCM-Manager the `plugin.xml` files of all installed plugins are read.
The SCM-Core interprets the information and can bind the classes with guice among other things.

### SCM-Annotations

| Annotation           | Description                                                                                                                                                                                                        | Usage                                                                                                            |
| -------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------- |
| Enrich               | Used to enrich classes (beans) new fields or add (HAL) links.                                                                                                                                                      | `@Enrich(Repository.class)` <br/> `public class RepositoryLinkEnricher implements HalEnricher {`                 |
| Event                | Used to mark events to which can be subscribed.                                                                                                                                                                    | `@Event` <br/> `public class PluginEvent {`                                                                      |
| WebElement           | Used to register servlets and filters.                                                                                                                                                                             | `@WebElement(value = HttpProtocolServlet.PATTERN)`                                                               |
| WebInitParam         | Used to initialize servlets which are using `@WebElement` with config parameter.                                                                                                                                   | Not used so far                                                                                                  |
| Extension            | Used to bind an extension (implementation) to an extension point (interface). <br/> Extension classes are bound automatically to the extension point interface with guice.                                         | `@Extension` <br/> `public class GitRepositoryHandler`                                                           |
| Extension Point      | Used to define extension points which can be extended by `@Extension` classes. <br/> On default the extension point can be extended by multiple extension. <br/> It can also be set to only one allowed extension. | `@ExtensionPoint(multi = false)` <br/> `public interface LogoutRedirection {`                                    |
| Plugin Annotation    | Used internally to mark other SCM-Annotations as plugin annotations. <br/> Plugin annotations can be used externally of the SCM-Core.                                                                              | `@PluginAnnotation("event")` <br/> `public @interface Event {}`                                                  |
| Requires             | Used to bound classes only if the specified plugin is installed. <br/> This is especially useful with optional plugins.                                                                                            | `@Requires("scm-editor-plugin")` <br/> `public class MergeOnlyChangeGuard implements ChangeGuard {`              |
| I18n                 | Used to define resource bundle keys for the I18nMessages class.                                                                                                                                                    | Not used so far                                                                                                  |
| Default              | Used to inject the default implementation of the service.                                                                                                                                                          | `@Default` <br/> `public class MustacheTemplateEngine implements TemplateEngine`                                 |
| Priority             | Used to define an order between several implementations.                                                                                                                                                           | `@Priority(1)` <br/> `public class ReadmeRepositoryContentInitializer implements RepositoryContentInitializer {` |
| AllowAnonymousAccess | Used to allow unauthenticated access to rest resource endpoints                                                                                                                                                    | `@AllowAnonymousAccess`                                                                                          |
| EagerSingleton       | Used to define Eager singleton scope for injection.                                                                                                                                                                | `@EagerSingleton` <br/> `public class GitRepositoryModifyListener {`                                             |

### Useful hints

#### Inject Extensions

The extensions which are bound to an extension point (interface) can be injected as a Set:

```java
 @Inject
 public AuthenticationFilter(ScmConfiguration configuration, Set<WebTokenGenerator> tokenGenerators) {
   this.configuration = configuration;
   this.tokenGenerators = tokenGenerators;
 }
```

If the extension point is defined to not accept multiple extensions by `multi=false` than the interface can be injected directly without a Set.

## Additional Annotations

### JAX-RS

With the JAX-RS annotation we define our rest resources.
Also we use the `javax.ws.rs.ext.@Provider` annotation to extend the JAX-RS runtime outside of the resources.

### Legman

Our event bus is based on legman. We use the `com.github.legman.@Subscribe` annotation to create event subscriber which listen to events fired by the legman event bus.
On default the event subscriber class reference is weak which means the java garbage collector will remove it if unused.
Also on default the subscriber is executed asynchronously. Both can be changed by attributes.

### Mapstruct

We use [Mapstruct Annotation](https://mapstruct.org/documentation/stable/reference/html/#defining-mapper) mainly to map
our business objects to data transfer objects (DTOs). Our DTOs always contains an "\_links" attribute since we are using [HAL](http://stateless.co/hal_specification.html).

### JAXB

To persist the data of SCM-Manager we use a file based storage api.
[JAXB](https://www.baeldung.com/jaxb) is for marshalling and unmarshalling the data fields to xml.
This means all objects which should be persisted need the JAXB annotations like `javax.xml.bind.annotation@XMLRootElement`
or `javax.xml.bind.annotation@XmlAccessorType(XmlAccessType.FIELD)` depending on the structure.

### Shiro

SCM-Manager uses a fine-grained permission model with Shiro.
To create permissions on business objects we use the `com.github.sdorra.ssp.@StaticPermission` annotation.

Example:

```
@StaticPermissions(
  value = "user",
  globalPermissions = {"create", "list", "autocomplete"},
  permissions = {"read", "modify", "delete", "changePassword", "changePublicKeys"},
  custom = true, customGlobal = true
)
```

### Guice

For dependency management we use [Google Guice](https://www.baeldung.com/guice).
The implementations are bound to the interfaces in classes named `Module` like `BootstrapModule.java`.

### Singleton
`javax.inject.@Singleton` to mark classes as singletons. This means the class will only be instantiated once by guice.

### Inject
`javax.inject.@Inject` to inject class instances into fields or constructors.

### Provider
Guice provider inject any type of instances which can be injected.

### RequestScoped
`com.google.inject.servlet.@RequestScoped` is applied to implementation classes when you want one instance per request.

## TODOs
- Overview Architecture (with PlantUML)
- REST API
- Store API (Persistence)
- Build Process
- Single Page Application (React, Redux)
- Authentication
- Authorization (Shiro)
- Packaging
- Templating
- ProtocolCommand SPI
- DataMigration (UpdateStep API)
